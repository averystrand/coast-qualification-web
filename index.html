<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Coast Qualification Engine</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; max-width: 600px; }
    h2 { margin-bottom: 1rem; }
    input { width: 400px; padding: 8px; font-size: 14px; }
    button { padding: 8px 12px; margin-left: 8px; font-size: 14px; cursor: pointer; }
    #result { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Company Qualification Lookup</h2>
  <input type="text" id="domain" placeholder="Enter company domain">
  <button onclick="lookupQualification()">Submit</button>
  <p id="result"></p>

  <script>
    async function lookupQualification() {
      const domain = document.getElementById("domain").value.trim();
      const resultBox = document.getElementById("result");
      resultBox.textContent = "Looking up...";

      if (!domain) {
        resultBox.textContent = "Please enter a domain.";
        return;
      }

      try {
        const submitRes = await fetch("https://linkedin-email-finder-proxy.vercel.app/api/submitQualification", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ Domain: domain })
        });

        if (!submitRes.ok) {
          const errorText = await submitRes.text();
          throw new Error(`Submit failed (${submitRes.status}): ${errorText}`);
        }

        const submitData = await submitRes.json().catch(() => ({}));
        const runId = submitData.runId || null;

        resultBox.textContent = "Waiting for enrichment…";

        let data = null;
        let attempts = 0;

        while (!data && attempts < 20) {
          attempts++;
          await new Promise(r => setTimeout(r, 3000));

          const params = runId
            ? `runId=${encodeURIComponent(runId)}`
            : `domain=${encodeURIComponent(domain)}`;
          const res = await fetch(`https://linkedin-email-finder-proxy.vercel.app/api/notifyQualification?${params}`);

          if (!res.ok) {
            const text = await res.text();
            throw new Error(`Notify failed (${res.status}): ${text}`);
          }

          const payload = await res.json();

          if (payload?.status !== "complete") {
            if (payload?.error) {
              throw new Error(payload.error);
            }
            data = null;
            continue;
          }

          data = payload;
        }

        if (!data) {
          resultBox.textContent = "No qualification data found.";
          return;
        }

        if (data?.normalized) {
          const n = data.normalized;
          resultBox.innerHTML = `
            Industry: ${n.Industry || "—"}<br>
            Employee Count: ${n.Employee_Count || "—"}<br>
            Swagger/Soap/Postman/OpenAPI: ${n.Swagger_Soap_Postman_OpenAPI || "—"}<br>
            Gateways: ${n.Gateways || "—"}<br>
            API URL: ${n.API_URL || "—"}<br>
            API/SDK Presence: ${n.API_SDK_Presence || "—"}
          `;
        } else {
          resultBox.textContent = "No qualification data found.";
        }
      } catch (err) {
        console.error(err);
        resultBox.textContent = "Error: " + err.message;
      }
    }
  </script>
</body>
</html>
